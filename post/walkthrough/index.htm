<section class="description-section">
  <h2>An example of how P works</h2>
  <p>
    Let's walk through a basic application written with P. We'll create two scripts,
    so that when they load (each in a different browser), they'll connect to each other and
    start sending each other "ping" and "pong" messages.
  </p>

  <h3>The onramp Server</h3>
  <p>
    <a href="https://github.com/unsetbit/onramp">onramp</a> is 
    a basic WebSocket server which follows the same protocol as P in establishing connections.
    Whenever onramp recieves a connection, it broadcasts the id of that connection to all of the
    other connections. This way, any connection to onramp can establish a peer connection to any other
    connection with the help of onramp.
  </p>

  <pre class="prettyprint linenums lang-js">
var Onramp = require('onramp');

// Create a default onramp instance at localhost:20500
var onramp = Onramp.create();

// Whenever a connection is established, tell it about all the 
// other connections available, and then broadcast its connection
// id to the rest of the connections so everyone always
// knows who is connected to the onramp
onramp.on("connection", function(connection){
  onramp.connections.forEach(function(other){
    // Don't send a connection its own id
    if(other === connection) return;
    
    connection.send(other.address);
    other.send(connection.address);
  });
});  
</pre>

  <h3>Ping Application</h3>
  The ping application runs on the browser. It connects to the onramp server and to any connection
  which connects to the onramp server. When it establishes a new peer connection, it sends a "ping"
  message and waits for a response. Then, whenever it receives a message, it responds with a "ping".

  <h4>ping.html</h4>
  <pre class="prettyprint linenums lang-html">
&lt;!doctype html&gt;&lt;title&gt;Ping&lt;/title&gt;
&lt;script src="/p.js"&gt;&lt;/script&gt;
&lt;script&gt;
	var p = P.create();

	var onrampServerAddress = 'ws://' + location.hostname + ':20500/';

	// Establish a connection to an onramp server. The onramp
	// server speaks the 'p' protocol and will allow us to make
	// connections to peers.
	console.log('connecting to onramp server at ' + onrampServerAddress);
	var onramp = p.connect(onrampServerAddress);

	// Whenever another peer connects to the onramp server (or
	// if there are already peers connected to it), it will send
	// a message with an address for the peer. We can then ask the 
	// onramp server to connect to the peer at the address.
	onramp.on('message', function(peerAddress){
		// Using the onramp connection as a signaling channel,
		// connect to peer addresss.
		console.log('connecting to peer at ' + peerAddress);
		var peer = onramp.connect({ address: peerAddress, offerData: "Hi!" });

		// When the connection opens, send an initial ping
		// to start the dialog
		peer.on('open', function(){
			console.log('connected to peer at ' + peerAddress);
			peer.send('ping?');
			console.log(peerAddress, ' <-- ', 'ping?');
		});

		// Whenever we receive a response from the peer,
		// wait one second and respond with another ping.
		peer.on('message', function(message){
			console.log(peerAddress, ' --> ', message);

			setTimeout(function(){
				peer.send('ping?');
				console.log(peerAddress, ' <-- ', 'ping?');
			}, 1000);
		});
	});

	// Get notifications of closed connections
	p.on('disconnection', function(peer){
		console.log(peer.address, ' disconnected');
	});
&lt;/script&gt;
</pre>

  <h3>Pong Application</h3>
  The pong application runs on the browser. It connects to the onramp server and to any connection
  which connects to the onramp server. It automatically accepts any connection requests and when
  a peer connection sends it a message, it responds with a "pong".

  <h4>pong.html</h4>
  <pre class="prettyprint linenums lang-html">
&lt;!doctype html&gt;&lt;title&gt;Pong&lt;/title&gt;
&lt;script src="/p.js"&gt;&lt;/script&gt;
&lt;script&gt;
	var p = P.create();

	var onrampServerAddress = 'ws://' + location.hostname + ':20500/';

	// Establish a connection to an onramp server. The onramp
	// server speaks the 'p' protocol and will allow us to make
	// connections to peers.
	console.log('connecting to onramp server at ' + onrampServerAddress);
	var onramp = p.connect(onrampServerAddress);
	
	// Await for a connection to occur via the onramp peer.
	onramp.on('connection', function(peer){
		console.log(peer.address, ' connecting');
		
		// Whenever we receive a message, output it and respond
		// with a 'pong!' after waiting for one second.
		peer.on('message', function(message){
			console.log(peer.address, ' --> ', message);
			setTimeout(function(){
				console.log(peer.address, ' <-- ', 'pong!');
				peer.send('pong!');
			}, 1000);
		});
	});

	// Get notifications of closed connections
	p.on('disconnection', function(peer){
		console.log(peer.address, ' disconnected');
	});
&lt;/script&gt;
</pre>

  <h3>Running the Example</h3>
  <p>
    Now that we know what all these pieces do, let's run it and see the results. 
    You'll need <a href="http://nodejs.org/">Node.js 0.10+</a> and 
    <a href="http://google.com/chrome">Chrome 26+</a> or <a href="www.getfirefox.com/â€Ž">Firefox 23+</a>. Once you have those installed,
    open up your console and execute the following (you may need <code>sudo</code>):
  </p>

  <pre class="prettyprint linenums">
npm install -g onramp; # installs the onramp server
npm install -g p-examples; # installs the p examples server
onramp&amp; # start the onramp server in the background
p-examples; # start the example server in the foreground
</pre>

  <p>
    If all goes well, you should see <code>P example server running on localhost:20501</code>.
  </p>
  <p>
    Finally, open <a href="http://localhost:20501/ping-pong/ping.html">http://localhost:20501/ping-pong/ping.html</a> in one tab
    and <a href="http://localhost:20501/ping-pong/pong.html">http://localhost:20501/ping-pong/pong.html</a> in another.
  </p>

  <p>
    If you open up the JavaScript console in either of the tabs, you should notice something like:
<pre>
...
314b4feb-a959-4d26-9f93-00cc2b2170f4  <--  pong! 
314b4feb-a959-4d26-9f93-00cc2b2170f4  -->  ping? 
314b4feb-a959-4d26-9f93-00cc2b2170f4  <--  pong! 
314b4feb-a959-4d26-9f93-00cc2b2170f4  -->  ping? 
...
</pre>
   Congratulations! You've established a direct connection from one browser to another, albeit on the same machine for the sake of simplicity.
  </p>

  <h3>What Happened?</h3>
  <p>
    <a href="resource/image/ping-pong-flow.png">
      <img src="resource/image/ping-pong-flow.png" />
    </a>
     <ol>
      <li>You opened ping.html in the browser</li>
      <li>
        Your browser opened a WebSocket connection between the Ping Application and the onramp server.
        Since there were no other connections to the onramp server at the time, nothing else happened.
      </li>
      <li>You opened pong.html in the browser</li>
      <li>
        Your browser opened a WebSocket connection between the Pong Application and the onramp server.
      </li>
      <li>
        Since there was already another connection to the onramp server (the Ping Application), the onramp
        server sent the id of the Pong Application to the Ping Application, and the id of the Ping Application
        to the Pong Application. 
      </li>
      <li>
        The Pong Application wasn't listening for remote addresses so the message from the onramp server was
        discarded.
      </li>
      <li>
        This Ping Application was listening for remote addresses, so when it received the remote address (of the 
        Pong Application), it asked the onramp server to help it establish a direct, peer-to-peer connection to it.
      </li>
      <li>
        The onramp server acted as the middle man the hand-shaking required for both peers to meet and connect 
        to each other.
      </li>
      <li>
        When the peer connection was established and open between the Ping and the Pong application, the Ping
        application send an initial "Ping?" message to the Pong application.
      </li>
      <li>
        The Pong Application was setup to respond to any message from a peer with a "Pong!" message, so when
        it received the "Ping?" message, it waited one second and sent a "Pong!" message back.
      </li>
      <li>
        The Ping Application was setup to respond to any message from a peer with a "Ping?" message, so when
        it received the "Pong!" message, it waited one second and sent a "Ping?" message back.
      </li>
    </ol>

    <p>
      Steps 10 and 11 will continue on until either tab is closed. Note that it will even continue if the onramp
      server is shutdown, because it is no longer being utilized by the two applications.
    </p>
  </p>
</section>
